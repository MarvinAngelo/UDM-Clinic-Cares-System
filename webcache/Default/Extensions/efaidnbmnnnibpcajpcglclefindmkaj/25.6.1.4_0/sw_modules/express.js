/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
import{analytics as e,events as t}from"../common/analytics.js";import{dcLocalStorage as n,dcSessionStorage as r}from"../common/local-storage.js";import{loggingApi as o}from"../common/loggingApi.js";import{CACHE_PURGE_SCHEME as s,EXPRESS as a,EXPRESS_CONTEXT_MENU_ENABLED_VERBS as c}from"./constant.js";import{floodgate as i}from"./floodgate.js";import{util as m}from"./util.js";import{viewerModuleUtils as p}from"./viewer-module-utils.js";import{common as l}from"./common.js";import{expressIndexedDBScript as E}from"../common/expressindexedDB.js";import{removeExperimentCodeForAnalytics as d,setExperimentCodeForAnalytics as u}from"../common/experimentUtils.js";import{OFFSCREEN_DOCUMENT_PATH as g}from"../common/constant.js";let S=!1;const f={},x="expressMenu",I={"dc-cv-express-standalone":"EL","dc-cv-express-standalone-control":"ELC","dc-cv-express-whatsapp-single-cta":"EWS","dc-cv-express-whatsapp-single-cta-control":"EWSC"},h="cleanUpExpressAssetMemoryMap",b="cleanUpExpressIndexedDB",R={beta:["memepcobodlebmohdlfnjiaalggfcpic","hgednelcgbmkdebjhejlmbgigmkcbemg"],release:["efaidnbmnnnibpcajpcglclefindmkaj","elhekieabhbkpmcefcoobjddigjcaadp"]},_={[a.VERBS.EFFECTS_IMAGE]:"add-effects",[a.VERBS.CROP_IMAGE]:"crop-image",[a.VERBS.REMOVE_BACKGROUND_IMAGE]:"remove-background",[a.VERBS.INSERT_OBJECT]:"insert-object",[a.VERBS.REMOVE_OBJECT]:"remove-object"};async function v(e){const t=Date.now(),n=await async function(e){const t=`${g}?env=${l.getEnv()}`;await m.setupOffscreenDocument(t);const n=await chrome.runtime.sendMessage({main_op:"fetchImageBlobURL",target:"offscreen",imgUrl:e});if(n.error)throw new Error(n.error);return n.blobUrl}(e),r=await fetch(n);if(!r.ok)throw new Error(`Blob fetch response not in 2xx range. Status: ${r.status}`);const o=await r.blob();return function(e){URL.revokeObjectURL(e)}(n),new Promise(((e,n)=>{const r=new FileReader;r.readAsDataURL(o),r.onloadend=()=>{const n=r.result,o=Date.now()-t;e({base64data:n,imageDownloadTime:o})},r.onerror=n}))}async function O(e){if(!await i.hasFlag(e))return!1;const t=i.getFeatureMeta(e);if(t)try{const e=JSON.parse(t);if(e.minExtVer&&m.verCmp(e.minExtVer,chrome.runtime.getManifest().version)>0)return!1}catch(e){}return!0}function w(e){return _[e]??"edit-image"}function A(e){return(r.getItem(a.EXPRESS_SESSIONS)||{})[e]}async function T(e,t){const n=Date.now(),o=new URL(t.url).hostname,s=e.srcUrl,c=t.id,i=e.intent,p=e.touchpoint,l=await async function(){return await O("dc-cv-express-standalone")?a.VARIANT.LOE:a.VARIANT.MODAL}(),E=m.uuid(),d=r.getItem(a.EXPRESS_SESSIONS)||{};return d[E]={pageDomain:o,imageURL:s,tabId:c,intent:i,touchpoint:p,variant:l,clickTimeStamp:n},r.setItem(a.EXPRESS_SESSIONS,d),E}async function L(e,t){const n=await T(e,t);await D(n)}function M(e){const t=r.getItem(a.EXPRESS_SESSIONS)||{};return Object.keys(t).find((n=>{const o=t[n];return o.tabId===e&&!o.fetchedFromContentScript&&o.variant===a.VARIANT.MODAL&&(t[n].fetchedFromContentScript=!0,r.setItem(a.EXPRESS_SESSIONS,t),!0)}))}async function D(s){const c=A(s);let i;const p=c?.pageDomain;try{if(i=c.intent,c.variant===a.VARIANT.LOE){const e=c.clickTimeStamp,t=e+864e5;E.storeExpressAssetInfoInIndexedDB(s,c.imageURL,t,e),chrome.alarms.get(b,(e=>{e||chrome.alarms.create(b,{periodInMinutes:720})})),f[s]={bufferPromise:v(c.imageURL),ttl:Date.now()+6e5,clickTimeStamp:e,domain:p},chrome.alarms.get(h,(e=>{e||chrome.alarms.create(h,{periodInMinutes:10})}));const r=new URL(l.getExpressURLs().webAppUrl);r.searchParams.append("expressSessionId",s),r.searchParams.append("referrer",a.REFERRER);const o=w(c.intent);r.searchParams.append("editAction",o),r.searchParams.append("extId",function(){const e=Object.keys(R).filter((e=>R[e].includes(chrome.runtime.id)));return e.length>0?e[0]:"release"}());const i=m.getFrictionlessLocale(chrome.i18n.getMessage("@@ui_locale"));r.searchParams.append("locale",i),"true"===n.getItem("adobeInternal")&&r.searchParams.append("setting-consoleLogLevel-performance","info"),chrome.tabs.create({url:r.href,active:!0})}else!function(e,t,n){let o=r.getItem(a.SESSIONS_WHERE_MODAL_LOADING)||[];o.push({tabId:e,touchpoint:t,domain:n}),r.setItem(a.SESSIONS_WHERE_MODAL_LOADING,o)}(c.tabId,c?.touchpoint,p),await chrome.scripting.executeScript({target:{tabId:c.tabId},files:["content_scripts/express-content-script.js"]})}catch(n){k(c?.tabId,c?.touchpoint,p),e.event(t.EXPRESS_EXECUTE_VERB_FAILED,{VERB:i,eventContext:n.toString(),expressTouchpoint:c?.touchpoint,domain:p}),o.error({message:"Error executing express verb",error:"Initiate execute verb from service worker: "+n.toString()})}}async function C(r){if(!f[r])return async function(n){let r,s,c;const i=A(n),m=await E.getExpressAssetInfoFromIndexedDB(n);if(!m)return o.error({message:"Error executing express verb",error:`Asset transfer to LOE failed: ${a.EXTERNAL_MESSAGING_ERROR_CODES.INVALID_REQUEST}`}),{status:a.RESPONSE_STATUS.FAILED,errorCode:a.EXTERNAL_MESSAGING_ERROR_CODES.INVALID_REQUEST};r=m.url,s=m.clickTimeStamp;try{c=(await v(r)).base64data}catch(n){return e.event(t.EXPRESS_EXECUTE_VERB_FAILED,{eventContext:n.toString(),domain:i?.pageDomain,expressTouchpoint:i?.touchpoint}),o.error({message:"Error executing express verb",error:`Asset transfer to LOE failed: ${n.toString()}`}),{status:a.RESPONSE_STATUS.FAILED,errorCode:a.EXTERNAL_MESSAGING_ERROR_CODES.IMAGE_FETCH_FAILED,clickTimeStamp:s}}return{status:a.RESPONSE_STATUS.SUCCESS,buffer:c,clickTimeStamp:s}}(r);{const s=A(r)?.touchpoint,c=f[r]?.domain,i=f[r].clickTimeStamp,m=Date.now()-i;try{const{base64data:e,imageDownloadTime:t}=await f[r].bufferPromise,s=Date.now()-i;"true"===n.getItem("adobeInternal")&&(console.log("Time required to receive request from express webapp "+m),console.log("Image Download Time "+t),console.log("Time required to handover to express "+s));const p={imageDownloadTime:t,timeRequiredToHandoverToExpress:s,expressCommunicationReceivedTime:m,imageSize:e.length};return o.info({message:a.PERF_METRIC_LOG_MESSAGE,...p}),{status:a.RESPONSE_STATUS.SUCCESS,buffer:e,clickTimeStamp:i,domain:c}}catch(n){e.event(t.EXPRESS_EXECUTE_VERB_FAILED,{eventContext:n.toString(),domain:c,expressTouchpoint:s}),o.error({message:"Error executing express verb",error:`Asset transfer to LOE failed: ${n.toString()}`});const r=a.EXTERNAL_MESSAGING_ERROR_CODES.IMAGE_FETCH_FAILED;return{status:a.RESPONSE_STATUS.FAILED,errorCode:r,clickTimeStamp:i,domain:c}}}}function P(e){chrome.scripting.executeScript({target:{tabId:e},func:()=>{!function(e){const t=document.querySelector(`#${e}`);t?.parentElement?.removeChild(t),document.body.style.overflow="auto"}("expressAcrobatExtension"),dialogToBeReopened&&(dialogToBeReopened.showModal(),dialogToBeReopened=void 0)}})}function N(){const e="true"===n.getItem("adobeInternal"),t=n.getItem("installSource");return e||"admin"!==t}async function y(){const e=N();for(const t of Object.keys(I)){const n=I[t];e&&await O(t)?u(n):d(n)}d("Exp_Mod"),d("Exp_Loe"),d("EC"),d("EWP"),d("EWPC"),d("EGN"),d("EGNC"),d("ECS"),d("ECSC"),d("EI2"),d("EI2C"),d("EGI"),d("EGIC")}async function U(e){const t=["http://*/*","https://*/*"];if((await F(e)).enableExpressContextMenu){if(!S){S=!0;const e=G(x,m.getTranslation("expressEditImageParentContextMenu"),["image"],t);chrome.contextMenus.create({id:"poweredByAdobeExpress",parentId:e,title:m.getTranslation("expressEditImagePoweredByExpressContextMenu"),contexts:["image"],enabled:!1,documentUrlPatterns:t}),chrome.contextMenus.create({id:"separatorForExpressMenu",parentId:e,type:"separator",contexts:["image"],documentUrlPatterns:t}),c.forEach((n=>{const r=n+"ContextMenu";G(r,m.getTranslation(r),["image"],t,e)}))}const e=await i.hasFlag("dc-cv-enable-splunk-logging",s.NO_CALL);p.enableSplunk(e)}else!async function(){S&&(S=!1,chrome.contextMenus.remove("poweredByAdobeExpress"),chrome.contextMenus.remove("separatorForExpressMenu"),Object.keys(c).forEach((e=>{const t=c[e]+"ContextMenu";chrome.contextMenus.remove(t)})),chrome.contextMenus.remove(x))}()}async function F(e){let t={enableExpressContextMenu:!1,enableExpressOptionsPagePreference:!1,enableExpressTooltip:!1};const r=await i.hasFlag("dc-cv-express-context-menu")||await O("dc-cv-express-standalone"),o=await i.hasFlag("dc-cv-express-context-menu-tooltip");if(null!=e&&""!==e||null!=(e=n.getItem("express-touch-points"))&&""!==e||(e=!0),await y(),r&&N()&&(t.enableExpressOptionsPagePreference=!0,e&&"false"!==e)){t.enableExpressContextMenu=!0;const e="true"===n.getItem(a.CONTEXT_MENU_INTERACTION_DONE);t.enableExpressTooltip=!e&&o}return n.removeItem("express-context-menu-fg-enabled-analytics-logged"),n.removeItem("express-image-right-click-fg-enabled-analytics-logged"),t}function G(e,t,n,r,o){return chrome.contextMenus.create({id:e,parentId:o,title:t,contexts:n,documentUrlPatterns:r})}function j(n){const s=function(e){let t=[],n=r.getItem(a.SESSIONS_WHERE_MODAL_LOADING)||[];n=n.filter((n=>n.tabId!==e||(t.push(n),!1))),t.length>0&&r.setItem(a.SESSIONS_WHERE_MODAL_LOADING,n);return t}(n);s.forEach((n=>{const r="Tab closed before express modal opened";o.error({message:"Error executing express verb",error:r}),e.event(t.EXPRESS_TAB_CLOSED_BEFORE_EXPRESS_LOADED,{eventContext:r,expressTouchpoint:n.touchpoint,domain:n.domain})}))}function k(e,t,n){let o=r.getItem(a.SESSIONS_WHERE_MODAL_LOADING)||[];const s=o.findIndex((r=>r.tabId===e&&r.touchpoint===t&&r.domain===n));s>-1&&(o.splice(s,1),r.setItem(a.SESSIONS_WHERE_MODAL_LOADING,o))}async function B(){const e={enableWhatsappPreviewExpressMenu:!1,enableExpressOptionsPagePreference:!1},t=await i.hasFlag("dc-cv-express-whatsapp-preview");let r=n.getItem("express-touch-points");return r=""===r||r,await y(),t&&N()&&(e.enableExpressOptionsPagePreference=!0,r&&"false"!==r&&(e.enableWhatsappPreviewExpressMenu=!0)),n.removeItem("express-whatsapp-preview-fg-enabled-analytics-logged"),n.removeItem("express-whatsapp-preview-fg-control-enabled-analytics-logged"),e}async function V(){const e={enableGmailNVExpressMenu:!1,enableExpressOptionsPagePreference:!1},t=await i.hasFlag("dc-cv-express-gmail-native-viewer");let r=n.getItem("express-touch-points");return r=""===r||r,await y(),t&&N()&&(e.enableExpressOptionsPagePreference=!0,r&&"false"!==r&&(e.enableGmailNVExpressMenu=!0)),n.removeItem("express-gmail-native-viewer-fg-enabled-analytics-logged"),n.removeItem("express-gmail-native-viewer-fg-control-enabled-analytics-logged"),e}async function X(){const e={enableGoogleImagePreviewExpressMenu:!1,enableExpressOptionsPagePreference:!1},t=await i.hasFlag("dc-cv-express-google-image-preview");let r=n.getItem("express-touch-points");return r=""===r||r,await y(),t&&N()&&(e.enableExpressOptionsPagePreference=!0,r&&"false"!==r&&(e.enableGoogleImagePreviewExpressMenu=!0)),n.removeItem("express-google-image-preview-fg-enabled-analytics-logged"),n.removeItem("express-google-image-preview-fg-control-enabled-analytics-logged"),e}chrome.alarms.onAlarm.addListener((function(e){e&&e.name===h&&(Object.keys(f).forEach((e=>{f[e]?.ttl<Date.now()&&delete f[e]})),0===Object.keys(f).length&&chrome.alarms.clear(h))})),chrome.alarms.onAlarm.addListener((function(e){e&&e.name===b&&E.removeExpressAssetInfoFromIndexedDB().then((()=>{E.getExpressAssetCount().then((e=>{0===e&&chrome.alarms.clear(b)}))}))}));export{D as executeExpressVerb,P as closeExpress,U as toggleExpressTouchpoints,F as isExpressContextMenuEnabled,C as getExpressAssetResponse,v as imageUrlToBase64,w as verbNameToIntent,k as removeSessionFromUnloadedExpressSessions,j as expressModalTabCloseListener,B as isWhatsappPreviewExpressMenuEnabled,V as isGmailNativeViewerExpressMenuEnabled,X as isGoogleImagePreviewExpressMenuEnabled,M as getModalSessionId,A as getExpressSession,L as launchExpress};